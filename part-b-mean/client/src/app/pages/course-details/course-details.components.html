<p *ngIf="loading" style="color: white;">Loading...</p>
<p *ngIf="!loading && error" style="color: white;">{{ error }}</p>

<ng-container *ngIf="!loading && !error && course as c">

    <header class="crs-dtl-header">
        <h1 id="course-title">{{ c.title }}</h1>
        <p id="course-description">{{ c.description }}</p>
    </header>

    <!-- LEARNING GOALS -->
    <div class="learning-goals-container course-details">
        <div class="tag">LEARNING GOALS</div>

        <div class="learning__goals__wrapper" id="learning__goals_wrapper">
            <ng-container *ngIf="learningGoals.length; else noGoals">

                <div class="learning__goal__item"
                    *ngFor="let goal of learningGoals; let i = index; trackBy: trackByIndex">
                    <span>{{ (i + 1) < 10 ? ('0' + (i + 1)) : (i + 1) }}</span>
                            <h5>{{goal.title}}</h5>
                            <p>{{goal.text}}</p>
                </div>
            </ng-container>

            <ng-template #noGoals>
                <p class="empty-state">No learning goals available for this course yet.</p>
            </ng-template>
        </div>
    </div>

    <main class="main-description-course">
        <h2>
            Explore the full structure of this course below, with each section
            explained in detail so you know exactly what you will learn, practice,
            and achieve.
        </h2>

        <!-- COURSE SECTIONS / MODULES -->
        <section class="course-section" id="course___section">

            <ng-container *ngIf="sections.length; else noSections">

                <div class="course-modules-wrapper" *ngFor="let s of sections;let i =index; trackBy: trackByIndex">
                    <div class="course-modules-section-title-row">
                        <h2>Section 0{{i+1}}: {{ s.title || 'Module' }}</h2>
                        <p>{{ s.summary || '' }}</p>

                    </div>

                    <div class="course-model-slider" *ngIf="s.lessons?.length">
                        <div class="course-module"
                            *ngFor="let lesson of s.lessons; let j = index; trackBy: trackByIndex">
                            <div class="tag-row">
                                <div class="tag lesson">Lesson {{ j + 1 }}</div>
                                <div class="tag-line"></div>
                            </div>
                            <h1>{{lesson.title}}</h1>
                            <div class="tag-row">
                                <div class="tag">Duration: {{lesson.minutes}}</div>
                            </div>
                            <p>{{lesson.summary}}</p>
                            <a href="#" (click)="$event.preventDefault(); onStartLearning(lesson)">
                                Start Learning
                            </a>
                        </div>
                    </div>
                </div>
            </ng-container>

            <ng-template #noSections>
                <p class="empty-state">No modules/sections available for this course yet.</p>
            </ng-template>
        </section>

        <!-- PROPOSED BOOKS / VIDEO-->
        <section class="course__more__details">
            <div class="course__proposed__book__sec">
                <div class="__proposed__books_title">
                    <h1>Extend your knowledge</h1>
                    <p>Here are a few books we recommend for this course.</p>
                </div>

                <div class="__proposed__books__main" id="proposed__bks">
                    <ng-container *ngIf="recommendedBooks.length; else noRecBooks">
                        <a class="card" *ngFor="let b of recommendedBooks; trackBy: trackByIndex"
                            [routerLink]="['/book-details', b.bookId]">
                            <div class="card-info">
                                <div class="tag-row">
                                    <div class="tag">{{b.category}}</div>
                                    <div class="tag">{{b.difficulty}}</div>
                                </div>
                                <h2>{{b.title}}</h2>
                                <p>{{b.reason}}</p>
                            </div>
                            <div class="card-img-cont">
                                <img [src]="b.cover" [alt]="b.title">
                            </div>

                        </a>
                    </ng-container>

                    <ng-template #noRecBooks>
                        <p class="empty-state">No recommended books for this course yet.</p>
                    </ng-template>
                </div>
            </div>
        </section>

        <section class="__course__prop_video">
            <div class="__course__prop_video_title">
                <h1>Get even better</h1>
                <p>Here is one video we recommend for this course.</p>
            </div>

            <div class="__inject_prop_vd" id="__prop__vd">
                <ng-container *ngIf="recommendedVideos.length; else noRecVideos">
                    <a class="new-box" *ngFor="let v of recommendedVideos; trackBy: trackByIndex"
                        [routerLink]="['/video-details', v._id]">
                        <div class="new-box-header">
                            <span>Recomended</span>
                            <h4>{{v.title}}</h4>
                            <h3>{{v.description}}</h3>
                            <p>{{v.category}}</p>
                        </div>
                        <div class="new-box-content">
                            <img [src]="v.cover" [alt]="v.title">
                        </div>
                    </a>
                </ng-container>
                <ng-template #noRecVideos>
                    <p class="empty-state">No recommended videos for this course yet.</p>
                </ng-template>
            </div>
        </section>
    </main>

    <!-- QUESTIONS-->
    <div class="more-quest-wrapper" *ngIf="c.questions?.length">
        <div class="more-qst-row">
            <h1>Got More questions? We've got your answers</h1>

            <div class="courses-detail-accordion module">
                <div class="accordion-item" *ngFor="let qa of c.questions; let i = index; trackBy: trackByIndex">
                    <button class="accordion-trigger qst" [attr.aria-expanded]="i === 0 ? 'true' : 'false'"
                        [attr.aria-controls]="'qst-detail-panel-' + i" [attr.id]="'qst-detail-trigger-' + i">
                        <span class="course-span">{{ qa.question }}</span>
                        <i class="fa-solid fa-chevron-down" aria-hidden="true"></i>
                    </button>

                    <div class="accordion-panel" [attr.id]="'qst-detail-panel-' + i" role="region"
                        [attr.aria-labelledby]="'qst-detail-trigger-' + i">
                        <div class="accordion-panel-inner qst">
                            <p>{{ qa.answer }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <a *ngIf="isEnrolled" class="enrolled-badge" aria-disabled="true">Enrolled</a>
            <!-- if NOT enrolled display the btn -->
            <a *ngIf="!isEnrolled" href="#" id="subscribeNowBtn"
                (click)="$event.preventDefault(); openSubscribeModal()">
                Subscribe Now
            </a>
        </div>
    </div>

    <!-- MODAL -->
    <div class="modal" id="subscribeModal" [attr.aria-hidden]="!modalOpen">
        <div class="modal__backdrop" data-close (click)="closeModal()"></div>

        <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="subscribeTitle"
            aria-describedby="subscribeDesc">
            <h2 id="subscribeTitle">{{ modalTitle }}</h2>
            <p id="subscribeDesc">{{ modalDesc }}</p>

            <div class="modal__actions">
                <button type="button" class="modal__btn" data-close (click)="closeModal()"
                    *ngIf="modalMode === 'subscribe-confirm'">
                    Cancel
                </button>

                <button type="button" class="modal__btn modal__btn--primary" id="confirmSubscribeBtn"
                    (click)="onConfirmModal()">
                    {{ modalConfirmText }}
                </button>
            </div>
        </div>
    </div>


    <!-- REVIEWS placeholders -->
    <!-- REVIEWS -->
    <section class="reviews-section" id="reviews-section">
        <h1>Reviews</h1>

        <!-- overall -->
        <div class="overall-rating-wrapper">
            <ng-container *ngIf="reviews.length; else noReviews">
                <div class="overall-rating">
                    <h2>Overall Rating</h2>

                    <div class="overall-rating__value">
                        <strong>{{ avgRating.toFixed(1) }}</strong>

                        <div class="stars" aria-label="Average rating">
                            <i *ngFor="let _ of [1,2,3,4,5]; let i = index" class="fa-star"
                                [ngClass]="(i + 1) <= roundRating(avgRating) ? 'fa-solid' : 'fa-regular'">
                            </i>
                        </div>

                        <span class="overall-rating__count">({{ reviews.length }})</span>
                    </div>
                </div>
            </ng-container>

            <ng-template #noReviews>
                <p class="empty-state">No reviews for this course yet.</p>
            </ng-template>
        </div>

        <!-- list -->
        <div class="ratings-wrapper">
            <ng-container *ngIf="reviews.length; else noList">
                <div class="rating-item" *ngFor="let r of reviews; trackBy: trackByIndex">
                    <h2>{{ r.user?.userName || 'User' }}</h2>
                    <h6>{{ r.createdAt | date:'mediumDate' }}</h6>

                    <div class="stars" aria-label="User rating">
                        <i *ngFor="let _ of [1,2,3,4,5]; let i = index" class="fa-star"
                            [ngClass]="(i + 1) <= (r.rating || 0) ? 'fa-solid' : 'fa-regular'">
                        </i>
                    </div>

                    <p>{{ r.comment }}</p>
                </div>
            </ng-container>

            <ng-template #noList>
                <p class="empty-state">Be the first to review this course.</p>
            </ng-template>
        </div>
    </section>

    <!-- REVIEW FORM -->
    <section class="review-form-section">
        <h1>{{ myReview ? 'Update Your Review' : 'Leave Your Review' }}</h1>

        <!-- gate message -->
        <div id="review-gate" class="review-gate" *ngIf="!canReview">
            <p>You can not leave a review at this time.</p>
            <p *ngIf="reviewError">
                {{ reviewError }}
            </p>
        </div>



        <form class="review-form" *ngIf="canReview" (ngSubmit)="submitReview()">
            <div class="form-column">
                <label for="review-rating">Rating</label>
                <select id="review-rating" required [(ngModel)]="reviewRating" name="rating">
                    <option value="" disabled>Select rating</option>
                    <option value="5">5 - Excellent</option>
                    <option value="4">4 - Very good</option>
                    <option value="3">3 - Good</option>
                    <option value="2">2 - Ok</option>
                    <option value="1">1 - Bad</option>
                </select>
            </div>

            <div class="form-column">
                <label for="review-comment">Comment</label>
                <textarea id="review-comment" rows="4" required [(ngModel)]="reviewComment" name="comment">
      </textarea>
            </div>

            <button type="submit" class="submit-btn" [disabled]="reviewSaving">
                {{ reviewSaving ? 'Saving...' : (myReview ? 'Update review' : 'Submit review') }}
            </button>
        </form>
    </section>

</ng-container>